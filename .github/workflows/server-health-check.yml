name: Server Health Check

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-servers:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create backend db directory
        run: cmd /c "mkdir backend\db"

      - name: Create backend database file
        run: cmd /c "type nul > backend\db\progress-dashboard.db"

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build backend (TypeScript)
        run: npx tsc
        working-directory: backend

      - name: Build frontend (Vite)
        run: npm run build
        working-directory: frontend

      - name: Start backend
        run: cmd /c "cd backend && npm run dev"

      - name: Start frontend
        run: cmd /c "cd frontend && npm run dev"

      - name: Wait for servers to start
        run: timeout /t 10

      - name: Check backend health
        run: curl --fail http://localhost:4000/ || exit 1

      - name: Check frontend health
        run: curl --fail http://localhost:5173/ || exit 1
