name: Server Health Check

on: [push, pull_request]

jobs:
  test-servers:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build backend
        run: npx tsc
        working-directory: backend

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Start backend
        run: start /b cmd /c "cd backend && npm run dev"
      
      - name: Start frontend
        run: start /b cmd /c "cd frontend && npm run dev"

      - name: Wait for servers to start
        run: timeout /t 10

      - name: Check backend health
        run: curl --fail http://localhost:4000/ || exit 1

      - name: Check frontend health
        run: curl --fail http://localhost:5173/ || exit 1

      - name: Kill backend
        run: taskkill /IM node.exe /F

      - name: Kill frontend
        run: taskkill /IM node.exe /F
